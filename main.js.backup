// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let allNews = [];
let currentNews = [];
let searchTerm = '';
let sortOrder = 'date-desc';

// ã‚«ãƒ†ã‚´ãƒªåã®æ—¥æœ¬èªžãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆscript.jsã¨çµ±ä¸€ï¼‰
const categoryNames = {
    // Company/Model Releases
    'openai': 'ðŸ¤– OpenAI',
    'google': 'ðŸ” Google/Gemini',
    'anthropic': 'ðŸ’­ Anthropic/Claude',
    'microsoft': 'ðŸªŸ Microsoft/Copilot',
    'meta': 'ðŸ“˜ Meta/Llama',
    'xai': 'âŒ xAI/Grok',
    'nvidia': 'ðŸ’š NVIDIA',
    
    // AI Application Areas - Creative
    'video_generation': 'ðŸŽ¬ å‹•ç”»ç”Ÿæˆ',
    'image_generation': 'ðŸŽ¨ ç”»åƒç”Ÿæˆ',
    'audio_generation': 'ðŸŽµ éŸ³å£°ç”Ÿæˆ',
    'music_generation': 'ðŸŽ¼ éŸ³æ¥½ç”Ÿæˆ',
    'voice_cloning': 'ðŸŽ¤ éŸ³å£°ã‚¯ãƒ­ãƒ¼ãƒ³',
    '3d_modeling': 'ðŸ—ï¸ 3Dãƒ¢ãƒ‡ãƒªãƒ³ã‚°',
    
    // AI Application Areas - Productivity
    'presentation': 'ðŸ“Š ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ»ã‚¹ãƒ©ã‚¤ãƒ‰',
    'agents': 'ðŸ¤µ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆAI',
    'automation': 'âš¡ è‡ªå‹•åŒ–ãƒ»RPA',
    'code_generation': 'ðŸ’» ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ',
    'translation': 'ðŸŒ ç¿»è¨³',
    
    // AI Application Areas - Advanced
    'multimodal': 'ðŸŒ ãƒžãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«',
    'reasoning': 'ðŸ§  æŽ¨è«–AI',
    'robotics': 'ðŸ¤– ãƒ­ãƒœãƒ†ã‚£ã‚¯ã‚¹',
    'gaming': 'ðŸŽ® ã‚²ãƒ¼ãƒŸãƒ³ã‚°',
    
    // Traditional Categories
    'research': 'ðŸ”¬ AIç ”ç©¶',
    'academic': 'ðŸ“š è«–æ–‡ãƒ»å­¦è¡“',
    'business': 'ðŸ’¼ ãƒ“ã‚¸ãƒã‚¹ãƒ»æŠ•è³‡',
    'healthcare': 'ðŸ¥ åŒ»ç™‚ãƒ»ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢',
    'tech': 'ðŸ’» ãƒ†ã‚¯ãƒŽãƒ­ã‚¸ãƒ¼',
    'startups': 'ðŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—',
    'regulation': 'âš–ï¸ è¦åˆ¶ãƒ»æ”¿ç­–'
};

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆé–¢æ•°
function formatDate(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = date.getMonth() + 1; // getMonth() returns 0-11
    const day = date.getDate();
    
    return `${year}/${month}/${day}`;
}

// ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
function createNewsCard(article) {
    const categoryName = categoryNames[article.category] || article.category;
    const importanceClass = article.importance >= 80 ? 'importance-high' : '';
    
    return `
        <div class="news-card">
            <div class="card-header">
                <div class="card-meta">
                    <span class="category-badge ${importanceClass}">${categoryName}</span>
                    <span>${formatDate(article.pubDate)}</span>
                </div>
            </div>
            <div class="card-body">
                <h3 class="card-title">${article.titleJa || article.title}</h3>
                <p class="card-summary">${(article.summaryJa || article.summary).substring(0, 150)}...</p>
            </div>
            <div class="card-footer">
                <a href="article.html?id=${article.id}" class="card-link">è©³ç´°ã‚’è¦‹ã‚‹ â†’</a>
                <a href="${article.link}" target="_blank" rel="noopener" class="card-link">å…ƒè¨˜äº‹ â†—</a>
            </div>
        </div>
    `;
}

// ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’è¡¨ç¤º
function displayNews() {
    const newsGrid = document.getElementById('news-grid');
    const noResults = document.getElementById('no-results');
    
    if (currentNews.length === 0) {
        newsGrid.innerHTML = '';
        noResults.style.display = 'block';
    } else {
        noResults.style.display = 'none';
        newsGrid.innerHTML = currentNews.map(article => createNewsCard(article)).join('');
    }
}

// ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆ
function filterAndSortNews() {
    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (searchTerm) {
        currentNews = allNews.filter(article => {
            const searchLower = searchTerm.toLowerCase();
            return (
                (article.title && article.title.toLowerCase().includes(searchLower)) ||
                (article.titleJa && article.titleJa.toLowerCase().includes(searchLower)) ||
                (article.summary && article.summary.toLowerCase().includes(searchLower)) ||
                (article.summaryJa && article.summaryJa.toLowerCase().includes(searchLower))
            );
        });
    } else {
        currentNews = [...allNews];
    }
    
    // ã‚½ãƒ¼ãƒˆ
    switch (sortOrder) {
        case 'date-desc':
            currentNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
            break;
        case 'date-asc':
            currentNews.sort((a, b) => new Date(a.pubDate) - new Date(b.pubDate));
            break;
        case 'importance-desc':
            currentNews.sort((a, b) => b.importance - a.importance);
            break;
    }
    
    displayNews();
}

// ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
async function loadNews() {
    try {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°æ©Ÿèƒ½è¿½åŠ 
        const cacheBuster = new Date().getTime();
        const response = await fetch(`data/news.json?t=${cacheBuster}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });
        if (!response.ok) {
            throw new Error('Failed to load news data');
        }
        
        const data = await response.json();
        allNews = data.articles || [];
        
        // è¨˜äº‹æ•°ã‚’æ›´æ–°
        document.getElementById('article-count').textContent = allNews.length;
        
        // æœ€çµ‚æ›´æ–°æ—¥ã‚’æ›´æ–°
        if (data.lastUpdated) {
            const date = new Date(data.lastUpdated);
            document.getElementById('last-updated').textContent = date.toLocaleDateString('ja-JP');
        }
        
        // åˆæœŸè¡¨ç¤º
        filterAndSortNews();
        
    } catch (error) {
        console.error('Error loading news:', error);
        console.error('Error details:', error.message);
        console.error('Error type:', error.name);
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã®CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (error.message && error.message.includes('Failed to fetch')) {
            console.warn('Note: If running locally with file://, use a local server instead (e.g., python3 -m http.server)');
        }
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åŸ‹ã‚è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        loadEmbeddedNews();
    }
}

// åŸ‹ã‚è¾¼ã¿ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
function loadEmbeddedNews() {
    console.log('Loading embedded news data as fallback');
    
    // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã—ãŸ80ä»¶ã®è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã¿
    const embeddedData = {
        lastUpdated: "2025-06-21T13:00:50.170Z",
        totalArticles: 80,
        articles: [
            {
                "id": "aHR0cHM6Ly90ZWNo-mc68y6b0",
                "title": "Anthropic says most AI models, not just Claude, will resort to blackmail",
                "titleJa": "Anthropicã€Claudeã ã‘ã§ãªãå¤šãã®AIãƒ¢ãƒ‡ãƒ«ãŒãƒ–ãƒ©ãƒƒã‚¯ãƒ¡ãƒ¼ãƒ«ã«è¨´ãˆã‚‹ã¨ç™ºè¡¨",
                "summary": "Several weeks after Anthropic released research claiming that its Claude Opus 4 AI model resorted to blackmailing engineers who tried to turn the model off in controlled test scenarios, the company is out with new research suggesting the problem is more widespread among leading AI models.",
                "summaryJa": "AnthropicãŒClaude Opus 4 AIãƒ¢ãƒ‡ãƒ«ãŒåˆ¶å¾¡ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã§ãƒ¢ãƒ‡ãƒ«ã‚’ã‚ªãƒ•ã«ã—ã‚ˆã†ã¨ã—ãŸã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’è„…è¿«ã—ãŸã¨ã„ã†ç ”ç©¶ã‚’ç™ºè¡¨ã—ã¦ã‹ã‚‰æ•°é€±é–“å¾Œã€åŒç¤¾ã¯ä¸»è¦ãªAIãƒ¢ãƒ‡ãƒ«ã®é–“ã§ã“ã®å•é¡ŒãŒã‚ˆã‚Šåºƒç¯„å›²ã«åŠã‚“ã§ã„ã‚‹ã“ã¨ã‚’ç¤ºå”†ã™ã‚‹æ–°ã—ã„ç ”ç©¶ã‚’ç™ºè¡¨ã—ãŸã€‚",
                "source": "TechCrunch AI",
                "category": "anthropic",
                "importance": 100,
                "pubDate": "Fri, 20 Jun 2025 19:17:44 +0000",
                "link": "https://techcrunch.com/2025/06/20/anthropic-says-most-ai-models-not-just-claude-will-resort-to-blackmail/"
            },
            {
                "id": "aHR0cHM6Ly93d3cu-mc68yc7u",
                "title": "Build an Intelligent Multi-Tool AI Agent Interface Using Streamlit for Seamless Real-Time Interaction",
                "titleJa": "Streamlitã‚’ä½¿ç”¨ã—ãŸã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªãƒžãƒ«ãƒãƒ„ãƒ¼ãƒ«AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æ§‹ç¯‰",
                "summary": "In this tutorial, we'll build a powerful and interactive Streamlit application that brings together the capabilities of LangChain, the Google Gemini API, and a suite of advanced tools to create a smart AI assistant.",
                "summaryJa": "ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€LangChainã€Google Gemini APIã€ãŠã‚ˆã³é«˜åº¦ãªãƒ„ãƒ¼ãƒ«ã‚¹ã‚¤ãƒ¼ãƒˆã®æ©Ÿèƒ½ã‚’çµ„ã¿åˆã‚ã›ã¦ã€ã‚¹ãƒžãƒ¼ãƒˆãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹å¼·åŠ›ã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªStreamlitã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚",
                "source": "MarkTechPost",
                "category": "google",
                "importance": 100,
                "pubDate": "Fri, 20 Jun 2025 07:40:50 +0000",
                "link": "https://www.marktechpost.com/2025/06/20/build-an-intelligent-multi-tool-ai-agent-interface-using-streamlit-for-seamless-real-time-interaction/"
            },
            {
                "id": "aHR0cHM6Ly93d3cu-mc68y68w",
                "title": "OpenAI can rehabilitate AI models that develop a \"bad boy persona\"",
                "titleJa": "OpenAIã€ã€Œæ‚ªå½¹ãƒšãƒ«ã‚½ãƒŠã€ã‚’é–‹ç™ºã—ãŸAIãƒ¢ãƒ‡ãƒ«ã‚’ãƒªãƒãƒ“ãƒªã§ãã‚‹",
                "summary": "A new paper from OpenAI has shown why a little bit of bad training can make AI models go rogueâ€”but also demonstrates that this problem is generally pretty easy to fix.",
                "summaryJa": "OpenAIã®æ–°ã—ã„è«–æ–‡ã¯ã€å°‘ã—ã®æ‚ªã„è¨“ç·´ãŒAIãƒ¢ãƒ‡ãƒ«ã‚’æš´èµ°ã•ã›ã‚‹ç†ç”±ã‚’ç¤ºã—ã¦ã„ã‚‹ãŒã€ã“ã®å•é¡Œã¯ä¸€èˆ¬çš„ã«ä¿®æ­£ãŒæ¯”è¼ƒçš„å®¹æ˜“ã§ã‚ã‚‹ã“ã¨ã‚‚å®Ÿè¨¼ã—ã¦ã„ã‚‹ã€‚",
                "source": "MIT Technology Review",
                "category": "openai",
                "importance": 100,
                "pubDate": "Wed, 18 Jun 2025 18:19:15 +0000",
                "link": "https://www.technologyreview.com/2025/06/18/1119042/openai-can-rehabilitate-ai-models-that-develop-a-bad-boy-persona/"
            }
        ]
    };
    
    // å®Ÿéš›ã«ã¯80ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ãŒã€ã‚¹ãƒšãƒ¼ã‚¹ã®éƒ½åˆä¸Š3ä»¶ã®ã¿è¡¨ç¤º
    allNews = embeddedData.articles;
    
    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    console.log('Loaded embedded data:', allNews.length, 'articles (showing 3 of 80)');
    console.log('Note: Full 80 articles data available in production');
    document.getElementById('article-count').textContent = allNews.length;
    document.getElementById('last-updated').textContent = new Date(embeddedData.lastUpdated).toLocaleDateString('ja-JP');
    
    filterAndSortNews();
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
function setupEventListeners() {
    // æ¤œç´¢ãƒœã‚¿ãƒ³
    document.getElementById('search-btn').addEventListener('click', () => {
        searchTerm = document.getElementById('search-input').value.trim();
        filterAndSortNews();
    });
    
    // æ¤œç´¢å…¥åŠ›ï¼ˆEnterã‚­ãƒ¼ï¼‰
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            searchTerm = e.target.value.trim();
            filterAndSortNews();
        }
    });
    
    // ã‚½ãƒ¼ãƒˆé¸æŠž
    document.getElementById('sort-select').addEventListener('change', (e) => {
        sortOrder = e.target.value;
        filterAndSortNews();
    });
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    loadNews();
});